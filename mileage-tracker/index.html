<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0a0f1a">
<title>Uber Trip Report</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0f1a; --bg2: #0f1629; --bg3: #111827;
  --surface: rgba(255,255,255,0.03); --surface2: rgba(255,255,255,0.05);
  --border: rgba(255,255,255,0.06); --border2: rgba(255,255,255,0.1);
  --text: #e2e8f0; --text2: #94a3b8; --text3: #64748b; --bright: #f1f5f9;
  --purple: #6366f1; --purple-light: #a5b4fc; --purple-bg: rgba(99,102,241,0.12); --purple-border: rgba(99,102,241,0.25);
  --green: #34d399; --green-bright: #10b981; --green-bg: rgba(16,185,129,0.08);
  --blue: #60a5fa; --yellow: #fbbf24; --amber: #f59e0b;
  --red: #ef4444; --red-bg: rgba(239,68,68,0.06); --red-border: rgba(239,68,68,0.15);
  --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --mono: 'JetBrains Mono', 'SF Mono', monospace;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
html, body {
  min-height: 100%; background: var(--bg);
  color: var(--text); font-family: var(--font);
  -webkit-font-smoothing: antialiased;
}
button { font-family: var(--font); border: none; cursor: pointer; }
input, select, textarea { font-family: var(--font); }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
.fade-in { animation: fadeIn 0.25s ease forwards; }

/* â”€â”€ Layout â”€â”€ */
#app { max-width: 560px; margin: 0 auto; padding: 0 0 calc(24px + var(--safe-bottom)); }

/* â”€â”€ Header â”€â”€ */
.header {
  padding: 16px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 10;
  background: rgba(10,15,26,0.92); backdrop-filter: blur(16px);
}
.header-left { display: flex; align-items: center; gap: 10px; }
.logo {
  width: 34px; height: 34px; border-radius: 8px; font-size: 15px;
  background: linear-gradient(135deg, var(--purple) 0%, #4f46e5 100%);
  display: flex; align-items: center; justify-content: center;
}
.header-title { font-size: 15px; font-weight: 700; color: var(--bright); }
.header-sub { font-size: 10px; color: var(--text3); letter-spacing: 0.05em; margin-top: 1px; }
.header-actions { display: flex; gap: 8px; align-items: center; }
.btn-sm {
  padding: 6px 12px; border-radius: 7px; font-size: 11px; font-weight: 600;
  background: var(--surface2); border: 1px solid var(--border2); color: var(--text2);
}
.btn-sm:hover { border-color: rgba(255,255,255,0.2); color: var(--text); }
.btn-sm.primary {
  background: var(--purple-bg); border-color: var(--purple-border);
  color: var(--purple-light);
}
.btn-sm.danger { background: var(--red-bg); border-color: var(--red-border); color: var(--red); }

/* â”€â”€ Content â”€â”€ */
.content { padding: 20px; }

/* â”€â”€ Setup / Login screens â”€â”€ */
.center-screen {
  min-height: 80vh; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 32px 20px; text-align: center;
}
.big-icon { font-size: 52px; margin-bottom: 16px; }
.screen-title { font-size: 22px; font-weight: 700; color: var(--bright); margin-bottom: 8px; }
.screen-sub { font-size: 14px; color: var(--text2); line-height: 1.6; max-width: 320px; margin-bottom: 28px; }

.btn-uber {
  display: flex; align-items: center; gap: 10px;
  padding: 14px 28px; border-radius: 12px; font-size: 15px; font-weight: 600;
  background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
  border: 1px solid rgba(255,255,255,0.12); color: #fff;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4); transition: transform 0.15s, box-shadow 0.15s;
}
.btn-uber:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(0,0,0,0.5); }
.uber-logo { font-size: 18px; font-weight: 900; letter-spacing: -0.04em; }

.btn-action {
  padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 600;
  background: linear-gradient(135deg, var(--green-bright), #059669);
  color: #fff; box-shadow: 0 2px 12px rgba(16,185,129,0.25);
  transition: transform 0.15s;
}
.btn-action:hover { transform: translateY(-1px); }

/* â”€â”€ Form â”€â”€ */
.form-group { margin-bottom: 16px; text-align: left; }
.form-label { font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 6px; display: block; letter-spacing: 0.04em; }
.form-input {
  width: 100%; padding: 10px 14px; border-radius: 8px; font-size: 13px;
  background: var(--surface2); border: 1px solid var(--border2); color: var(--text);
  outline: none; transition: border-color 0.15s;
  font-family: var(--mono);
}
.form-input:focus { border-color: var(--purple-border); }
.form-help { font-size: 11px; color: var(--text3); margin-top: 4px; }

.toggle-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 14px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px;
}
.toggle-label { font-size: 13px; color: var(--text2); }
.toggle {
  position: relative; width: 40px; height: 22px; background: var(--surface2);
  border-radius: 11px; border: 1px solid var(--border2); cursor: pointer;
  transition: background 0.2s;
}
.toggle.on { background: var(--purple); border-color: var(--purple); }
.toggle::after {
  content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px;
  background: #fff; border-radius: 50%; transition: left 0.2s;
}
.toggle.on::after { left: 20px; }

.form-box {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 20px; width: 100%; max-width: 380px;
  text-align: left;
}

/* â”€â”€ Summary bar â”€â”€ */
.summary {
  display: grid; grid-template-columns: 1fr 1fr 1fr;
  gap: 1px; background: var(--border); border-radius: 12px; overflow: hidden;
  margin-bottom: 20px; border: 1px solid var(--border);
}
.summary-cell {
  background: var(--surface); padding: 14px 12px; text-align: center;
}
.summary-label { font-size: 9px; color: var(--text3); font-weight: 600; letter-spacing: 0.08em; margin-bottom: 4px; }
.summary-val { font-size: 18px; font-weight: 700; font-family: var(--mono); }

/* â”€â”€ Session cards â”€â”€ */
.session {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; margin-bottom: 10px; overflow: hidden;
  transition: border-color 0.15s;
}
.session:hover { border-color: var(--border2); }
.session-head {
  padding: 14px 16px; cursor: pointer;
  display: flex; justify-content: space-between; align-items: flex-start;
}
.session-date { font-size: 13px; font-weight: 600; color: var(--bright); }
.session-meta { font-size: 11px; color: var(--text3); margin-top: 3px; }
.session-right { text-align: right; }
.session-net { font-size: 18px; font-weight: 700; font-family: var(--mono); color: var(--green); }
.session-miles { font-size: 11px; color: var(--text3); margin-top: 2px; font-family: var(--mono); }
.chevron { font-size: 12px; color: var(--text3); margin-top: 3px; transition: transform 0.2s; display: inline-block; }
.chevron.open { transform: rotate(180deg); }

.session-stats {
  display: flex; gap: 0; border-top: 1px solid var(--border);
  background: rgba(255,255,255,0.015);
}
.stat-pill { flex: 1; padding: 10px 8px; text-align: center; }
.stat-pill + .stat-pill { border-left: 1px solid var(--border); }
.stat-pill-label { font-size: 9px; color: var(--text3); font-weight: 600; letter-spacing: 0.06em; }
.stat-pill-val { font-size: 13px; font-weight: 700; font-family: var(--mono); margin-top: 2px; }

/* â”€â”€ Trip rows â”€â”€ */
.trips-list { border-top: 1px solid var(--border); }
.trip-row {
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: flex-start;
}
.trip-row:last-child { border-bottom: none; }
.trip-time { font-size: 12px; color: var(--text2); font-family: var(--mono); }
.trip-dur { font-size: 10px; color: var(--text3); margin-top: 2px; }
.trip-right { text-align: right; }
.trip-net { font-size: 14px; font-weight: 700; font-family: var(--mono); color: var(--green); }
.trip-detail { font-size: 10px; color: var(--text3); margin-top: 2px; font-family: var(--mono); }

/* â”€â”€ Info box â”€â”€ */
.info-box {
  padding: 12px 14px; border-radius: 8px; font-size: 12px; line-height: 1.55;
  margin-bottom: 12px;
}
.info-box.warn { background: rgba(251,191,36,0.06); border: 1px solid rgba(251,191,36,0.15); color: var(--yellow); }
.info-box.blue { background: var(--purple-bg); border: 1px solid var(--purple-border); color: var(--purple-light); }
.info-box.green { background: var(--green-bg); border: 1px solid rgba(16,185,129,0.2); color: var(--green); }

/* â”€â”€ Spinner â”€â”€ */
.spinner {
  width: 28px; height: 28px; border-radius: 50%; margin: 0 auto 12px;
  border: 2px solid var(--border2); border-top-color: var(--purple);
  animation: spin 0.8s linear infinite;
}

/* â”€â”€ Settings panel â”€â”€ */
.settings-panel {
  position: fixed; inset: 0; z-index: 100;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
  display: flex; align-items: flex-end; justify-content: center;
}
.settings-sheet {
  width: 100%; max-width: 560px; background: var(--bg2);
  border: 1px solid var(--border2); border-bottom: none;
  border-radius: 16px 16px 0 0; padding: 24px 20px 32px;
}
.settings-title {
  font-size: 15px; font-weight: 700; color: var(--bright);
  margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
}
.close-btn { background: none; color: var(--text3); font-size: 20px; line-height: 1; }
.close-btn:hover { color: var(--text); }

.empty { text-align: center; padding: 48px 20px; color: var(--text3); font-size: 13px; }
</style>
</head>
<body>
<div id="app"></div>
<script>
// â”€â”€ Config / Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KEYS = {
  config: 'uber-report-config',
  token:  'uber-report-token',
  cache:  'uber-report-cache',
};

const DEFAULT_CONFIG = { workerUrl: '', clientId: '', sandbox: true };

function loadConfig() {
  try { return { ...DEFAULT_CONFIG, ...JSON.parse(localStorage.getItem(KEYS.config)) }; }
  catch { return { ...DEFAULT_CONFIG }; }
}
function saveConfig(c) { localStorage.setItem(KEYS.config, JSON.stringify(c)); }

function loadToken() { return localStorage.getItem(KEYS.token) || null; }
function saveToken(t) { localStorage.setItem(KEYS.token, t); }
function clearToken() { localStorage.removeItem(KEYS.token); }

function loadCache() {
  try {
    const c = JSON.parse(localStorage.getItem(KEYS.cache));
    if (c && Date.now() - c.ts < 60 * 60 * 1000) return c; // 1 hour TTL
    return null;
  } catch { return null; }
}
function saveCache(data) { localStorage.setItem(KEYS.cache, JSON.stringify({ ...data, ts: Date.now() })); }
function clearCache() { localStorage.removeItem(KEYS.cache); }

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt$(n) {
  return '$' + Math.abs(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
function fmtMi(n) { return n.toFixed(1) + ' mi'; }
function fmtTime(unix) {
  return new Date(unix * 1000).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}
function fmtDur(secs) {
  const m = Math.round(secs / 60), h = Math.floor(m / 60);
  return h > 0 ? `${h}h ${m % 60}m` : `${m}m`;
}
function fmtDate(unix) {
  return new Date(unix * 1000).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
}
function dateKey(unix) {
  // YYYY-MM-DD in local time, for grouping
  const d = new Date(unix * 1000);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function el(tag, attrs = {}, ...children) {
  const e = document.createElement(tag);
  for (const [k, v] of Object.entries(attrs)) {
    if (k === 'cls') e.className = v;
    else if (k === 'html') e.innerHTML = v;
    else if (k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(), v);
    else e.setAttribute(k, v);
  }
  for (const child of children) {
    if (child == null) continue;
    e.append(typeof child === 'string' ? document.createTextNode(child) : child);
  }
  return e;
}

// â”€â”€ Uber API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uberGet(path, token, config) {
  const base = config.workerUrl.replace(/\/$/, '');
  const sep = path.includes('?') ? '&' : '?';
  const url = `${base}/api/${path}${sep}sandbox=${config.sandbox ? '1' : '0'}`;
  const resp = await fetch(url, {
    headers: { 'Authorization': `Bearer ${token}` },
  });
  if (resp.status === 401) throw Object.assign(new Error('Unauthorized'), { code: 401 });
  if (!resp.ok) throw new Error(`API error ${resp.status}`);
  return resp.json();
}

async function fetchAll(path, key, token, config) {
  const results = [];
  let offset = 0;
  const limit = 50;
  while (true) {
    const data = await uberGet(`${path}?limit=${limit}&offset=${offset}`, token, config);
    // Uber response wraps in an object â€” handle both shapes
    const inner = data[key] || data;
    const batch = (inner[key] || inner.trips || inner.payments || []);
    results.push(...batch);
    if (batch.length < limit) break;
    offset += limit;
  }
  return results;
}

async function fetchDriver(token, config) {
  return uberGet('v1/partners/me', token, config);
}

async function loadAllData(token, config) {
  const [trips, payments, driver] = await Promise.all([
    fetchAll('v1/partners/trips', 'trips', token, config),
    fetchAll('v1/partners/payments', 'payments', token, config),
    fetchDriver(token, config),
  ]);
  return { trips, payments, driver };
}

// â”€â”€ Data processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSessions(trips, payments) {
  // Index payments by trip_id
  const payMap = {};
  for (const p of payments) {
    if (!p.trip_id) continue;
    if (!payMap[p.trip_id]) payMap[p.trip_id] = [];
    payMap[p.trip_id].push(p);
  }

  // Group trips by calendar date
  const sessionMap = {};
  for (const trip of trips) {
    if (trip.status === 'cancelled') continue;
    const key = dateKey(trip.start_time);
    if (!sessionMap[key]) sessionMap[key] = { key, trips: [] };
    sessionMap[key].trips.push({ ...trip, payments: payMap[trip.id] || [] });
  }

  // Sort sessions newest first; sort trips within each session oldest first
  return Object.values(sessionMap)
    .sort((a, b) => b.key.localeCompare(a.key))
    .map(s => ({
      ...s,
      trips: s.trips.sort((a, b) => a.start_time - b.start_time),
    }));
}

function sessionStats(session) {
  let miles = 0, gross = 0, fees = 0, tolls = 0, net = 0;
  let tStart = Infinity, tEnd = 0;

  for (const trip of session.trips) {
    miles += trip.distance || 0;
    gross += trip.fare || 0;
    for (const p of trip.payments) {
      fees  += Math.abs(p.breakdown?.service_fee || 0);
      tolls += p.breakdown?.toll || 0;
      net   += p.amount || 0;
    }
    if (trip.start_time < tStart) tStart = trip.start_time;
    if (trip.end_time   > tEnd)   tEnd   = trip.end_time;
  }

  return {
    tripCount: session.trips.length,
    miles, gross, fees, tolls, net,
    duration: tEnd > tStart ? tEnd - tStart : 0,
    startTime: tStart === Infinity ? null : tStart,
  };
}

// â”€â”€ App State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  config:   loadConfig(),
  token:    loadToken(),
  driver:   null,
  sessions: [],
  totals:   { miles: 0, gross: 0, net: 0, trips: 0 },
  loading:  false,
  error:    null,
  expanded: new Set(),
  showSettings: false,
};

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const root = document.getElementById('app');
  root.innerHTML = '';

  const { config, token, driver, sessions, totals, loading, error, showSettings } = state;

  // Determine screen
  const needsSetup = !config.workerUrl || !config.clientId;
  const needsLogin = !token;

  // â”€â”€ Header â”€â”€
  const header = el('div', { cls: 'header' },
    el('div', { cls: 'header-left' },
      el('div', { cls: 'logo' }, 'ðŸš—'),
      el('div', {},
        el('div', { cls: 'header-title' }, 'Uber Trip Report'),
        el('div', { cls: 'header-sub' }, driver ? driver.first_name?.toUpperCase() + ' Â· ' + (config.sandbox ? 'SANDBOX' : 'LIVE') : 'RIDESHARE EARNINGS'),
      ),
    ),
    el('div', { cls: 'header-actions' },
      !needsSetup && el('button', { cls: 'btn-sm', onClick: () => { state.showSettings = true; render(); } }, 'âš™ï¸'),
      token && el('button', { cls: 'btn-sm', onClick: onRefresh }, loading ? 'â€¦' : 'â†»'),
      token && el('button', { cls: 'btn-sm danger', onClick: onLogout }, 'Disconnect'),
    ),
  );

  root.appendChild(header);

  // â”€â”€ Setup screen â”€â”€
  if (needsSetup) {
    root.appendChild(renderSetup());
    if (showSettings) root.appendChild(renderSettingsSheet());
    return;
  }

  // â”€â”€ Login screen â”€â”€
  if (needsLogin) {
    root.appendChild(renderLogin());
    if (showSettings) root.appendChild(renderSettingsSheet());
    return;
  }

  // â”€â”€ Dashboard â”€â”€
  const content = el('div', { cls: 'content fade-in' });

  if (error) {
    content.appendChild(el('div', { cls: 'info-box warn' }, `âš ï¸ ${error}`));
  }

  if (loading) {
    content.appendChild(el('div', { style: 'text-align:center;padding:40px 0' },
      el('div', { cls: 'spinner' }),
      el('div', { style: 'color:var(--text3);font-size:13px' }, 'Fetching tripsâ€¦'),
    ));
  } else if (sessions.length === 0) {
    content.appendChild(el('div', { cls: 'empty' }, 'No completed trips found.'));
  } else {
    // Summary
    content.appendChild(renderSummary(totals));
    // Sessions
    for (const session of sessions) content.appendChild(renderSession(session));
  }

  root.appendChild(content);
  if (showSettings) root.appendChild(renderSettingsSheet());
}

function renderSummary(t) {
  return el('div', { cls: 'summary' },
    el('div', { cls: 'summary-cell' },
      el('div', { cls: 'summary-label' }, 'TRIPS'),
      el('div', { cls: 'summary-val', style: 'color:var(--purple-light)' }, t.trips),
    ),
    el('div', { cls: 'summary-cell' },
      el('div', { cls: 'summary-label' }, 'MILES'),
      el('div', { cls: 'summary-val', style: 'color:var(--blue)' }, t.miles.toFixed(1)),
    ),
    el('div', { cls: 'summary-cell' },
      el('div', { cls: 'summary-label' }, 'NET EARNED'),
      el('div', { cls: 'summary-val', style: 'color:var(--green)' }, fmt$(t.net)),
    ),
  );
}

function renderSession(session) {
  const stats = sessionStats(session);
  const isOpen = state.expanded.has(session.key);

  const card = el('div', { cls: 'session' });

  const head = el('div', { cls: 'session-head',
    onClick: () => {
      isOpen ? state.expanded.delete(session.key) : state.expanded.add(session.key);
      render();
    }
  },
    el('div', {},
      el('div', { cls: 'session-date' }, fmtDate(stats.startTime)),
      el('div', { cls: 'session-meta' },
        `${stats.tripCount} trip${stats.tripCount !== 1 ? 's' : ''}` +
        (stats.duration ? ` Â· ${fmtDur(stats.duration)}` : ''),
      ),
    ),
    el('div', { cls: 'session-right' },
      el('div', { cls: 'session-net' }, fmt$(stats.net)),
      el('div', { cls: 'session-miles' }, fmtMi(stats.miles)),
      el('span', { cls: `chevron ${isOpen ? 'open' : ''}` }, 'â–¾'),
    ),
  );
  card.appendChild(head);

  const statsBar = el('div', { cls: 'session-stats' },
    ...[
      { label: 'GROSS', val: fmt$(stats.gross), color: 'var(--text-bright)' },
      { label: 'UBER FEE', val: 'âˆ’' + fmt$(stats.fees), color: 'var(--amber)' },
      { label: 'NET', val: fmt$(stats.net), color: 'var(--green)' },
    ].map(({ label, val, color }) =>
      el('div', { cls: 'stat-pill' },
        el('div', { cls: 'stat-pill-label' }, label),
        el('div', { cls: 'stat-pill-val', style: `color:${color}` }, val),
      )
    ),
  );
  card.appendChild(statsBar);

  if (isOpen) {
    const list = el('div', { cls: 'trips-list' });
    for (const trip of session.trips) list.appendChild(renderTrip(trip));
    card.appendChild(list);
  }

  return card;
}

function renderTrip(trip) {
  const gross = trip.fare || 0;
  const netPayment = trip.payments.reduce((s, p) => s + (p.amount || 0), 0);
  const fee = trip.payments.reduce((s, p) => s + Math.abs(p.breakdown?.service_fee || 0), 0);
  const dur = trip.start_time && trip.end_time ? trip.end_time - trip.start_time : null;

  return el('div', { cls: 'trip-row' },
    el('div', {},
      el('div', { cls: 'trip-time' },
        fmtTime(trip.start_time) + (trip.end_time ? ' â†’ ' + fmtTime(trip.end_time) : ''),
      ),
      el('div', { cls: 'trip-dur' },
        (dur ? fmtDur(dur) + ' Â· ' : '') + fmtMi(trip.distance || 0),
      ),
    ),
    el('div', { cls: 'trip-right' },
      el('div', { cls: 'trip-net' }, fmt$(netPayment || gross)),
      el('div', { cls: 'trip-detail' },
        gross ? `gross ${fmt$(gross)}${fee ? ` Â· fee âˆ’${fmt$(fee)}` : ''}` : 'â€”',
      ),
    ),
  );
}

function renderLogin() {
  const { config } = state;
  const redirectUri = location.origin + location.pathname;

  const btn = el('button', { cls: 'btn-uber',
    onClick: () => {
      const params = new URLSearchParams({
        client_id: config.clientId,
        response_type: 'code',
        scope: 'partner.trips partner.payments partner.accounts',
        redirect_uri: redirectUri,
        state: Math.random().toString(36).slice(2),
      });
      location.href = `https://login.uber.com/oauth/v2/authorize?${params}`;
    }
  },
    el('span', { cls: 'uber-logo' }, 'Uber'),
    'Connect with Uber',
  );

  const sandbox = el('div', { cls: 'info-box blue', style: 'margin-top:20px;max-width:340px;text-align:left' },
    `ðŸ§ª Sandbox mode ${config.sandbox ? 'ON' : 'OFF'} â€” ${config.sandbox ? 'using sandbox-api.uber.com' : 'using production API'}. Change in âš™ï¸ Settings.`,
  );

  const setupLink = el('button', { cls: 'btn-sm', style: 'margin-top:14px',
    onClick: () => { state.showSettings = true; render(); }
  }, 'âš™ï¸ Settings');

  return el('div', { cls: 'center-screen' },
    el('div', { cls: 'big-icon' }, 'ðŸš—'),
    el('div', { cls: 'screen-title' }, 'Trip Report'),
    el('div', { cls: 'screen-sub' }, 'Connect your Uber driver account to view your mileage, earnings, and expense reports by session.'),
    btn,
    sandbox,
    setupLink,
  );
}

function renderSetup() {
  const { config } = state;

  let wUrl = config.workerUrl;
  let cId   = config.clientId;
  let sand  = config.sandbox;

  const toggleEl = el('div', { cls: `toggle ${sand ? 'on' : ''}`,
    onClick: () => { sand = !sand; toggleEl.className = `toggle ${sand ? 'on' : ''}`; }
  });

  const save = el('button', { cls: 'btn-action', style: 'width:100%;margin-top:8px',
    onClick: () => {
      if (!wUrl.startsWith('http')) { alert('Enter a valid Worker URL (https://...)'); return; }
      if (!cId) { alert('Enter your Uber Client ID'); return; }
      const cfg = { workerUrl: wUrl.replace(/\/$/, ''), clientId: cId, sandbox: sand };
      state.config = cfg;
      saveConfig(cfg);
      render();
    }
  }, 'Save & Continue');

  const workerInput = el('input', { cls: 'form-input', type: 'text', placeholder: 'https://uber-report.your-name.workers.dev', value: wUrl });
  workerInput.addEventListener('input', e => { wUrl = e.target.value.trim(); });

  const clientInput = el('input', { cls: 'form-input', type: 'text', placeholder: 'your_uber_client_id', value: cId });
  clientInput.addEventListener('input', e => { cId = e.target.value.trim(); });

  return el('div', { cls: 'center-screen' },
    el('div', { cls: 'big-icon' }, 'âš™ï¸'),
    el('div', { cls: 'screen-title' }, 'First-time Setup'),
    el('div', { cls: 'screen-sub' }, 'Enter your Cloudflare Worker URL and Uber Client ID to get started.'),
    el('div', { cls: 'form-box' },
      el('div', { cls: 'form-group' },
        el('label', { cls: 'form-label' }, 'CLOUDFLARE WORKER URL'),
        workerInput,
        el('div', { cls: 'form-help' }, 'Deploy the worker in the /worker folder first. See README.'),
      ),
      el('div', { cls: 'form-group' },
        el('label', { cls: 'form-label' }, 'UBER CLIENT ID'),
        clientInput,
        el('div', { cls: 'form-help' }, 'From developer.uber.com â†’ your app â†’ Client ID (not the secret).'),
      ),
      el('div', { cls: 'toggle-row', style: 'margin-bottom:16px' },
        el('span', { cls: 'toggle-label' }, 'Sandbox mode'),
        toggleEl,
      ),
      save,
    ),
  );
}

function renderSettingsSheet() {
  const { config } = state;

  let wUrl = config.workerUrl;
  let cId   = config.clientId;
  let sand  = config.sandbox;

  const toggleEl = el('div', { cls: `toggle ${sand ? 'on' : ''}`,
    onClick: () => { sand = !sand; toggleEl.className = `toggle ${sand ? 'on' : ''}`; }
  });

  const close = () => { state.showSettings = false; render(); };

  const save = el('button', { cls: 'btn-action', style: 'width:100%;margin-top:4px',
    onClick: () => {
      const cfg = { workerUrl: wUrl.replace(/\/$/, ''), clientId: cId, sandbox: sand };
      state.config = cfg;
      saveConfig(cfg);
      clearCache();
      state.showSettings = false;
      render();
    }
  }, 'Save');

  const workerInput = el('input', { cls: 'form-input', type: 'text', value: wUrl });
  workerInput.addEventListener('input', e => { wUrl = e.target.value.trim(); });

  const clientInput = el('input', { cls: 'form-input', type: 'text', value: cId });
  clientInput.addEventListener('input', e => { cId = e.target.value.trim(); });

  const sheet = el('div', { cls: 'settings-panel', onClick: e => { if (e.target === sheet) close(); } },
    el('div', { cls: 'settings-sheet' },
      el('div', { cls: 'settings-title' },
        'Settings',
        el('button', { cls: 'close-btn', onClick: close }, 'Ã—'),
      ),
      el('div', { cls: 'form-group' },
        el('label', { cls: 'form-label' }, 'WORKER URL'),
        workerInput,
      ),
      el('div', { cls: 'form-group' },
        el('label', { cls: 'form-label' }, 'CLIENT ID'),
        clientInput,
      ),
      el('div', { cls: 'toggle-row', style: 'margin-bottom:16px' },
        el('span', { cls: 'toggle-label' }, 'Sandbox mode'),
        toggleEl,
      ),
      save,
    ),
  );
  return sheet;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function onRefresh() {
  clearCache();
  await loadData();
}

function onLogout() {
  clearToken();
  clearCache();
  state.token = null;
  state.driver = null;
  state.sessions = [];
  render();
}

async function loadData() {
  const { token, config } = state;

  const cached = loadCache();
  if (cached) {
    state.driver   = cached.driver;
    state.sessions = cached.sessions;
    state.totals   = cached.totals;
    render();
    return;
  }

  state.loading = true;
  state.error   = null;
  render();

  try {
    const { trips, payments, driver } = await loadAllData(token, config);
    const sessions = buildSessions(trips, payments);

    const totals = sessions.reduce((acc, s) => {
      const st = sessionStats(s);
      acc.trips += st.tripCount;
      acc.miles += st.miles;
      acc.gross += st.gross;
      acc.net   += st.net;
      return acc;
    }, { trips: 0, miles: 0, gross: 0, net: 0 });

    state.driver   = driver;
    state.sessions = sessions;
    state.totals   = totals;
    saveCache({ driver, sessions, totals });
  } catch (err) {
    if (err.code === 401) {
      clearToken();
      state.token = null;
    }
    state.error = err.message || 'Failed to load data';
  } finally {
    state.loading = false;
    render();
  }
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot() {
  // Handle OAuth callback (?code=...)
  const params = new URLSearchParams(location.search);
  const code = params.get('code');

  if (code) {
    history.replaceState({}, '', location.pathname);
    const { config } = state;
    try {
      const resp = await fetch(`${config.workerUrl}/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code, redirect_uri: location.origin + location.pathname }),
      });
      const data = await resp.json();
      if (data.access_token) {
        saveToken(data.access_token);
        state.token = data.access_token;
      } else {
        state.error = data.error_description || 'Token exchange failed';
      }
    } catch (e) {
      state.error = 'Could not reach worker: ' + e.message;
    }
  }

  render();

  if (state.token) {
    await loadData();
  }
}

boot();
</script>
</body>
</html>
