<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SC Haulmaster</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f1419">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SC Haulmaster">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text y='50' font-size='40' fill='%2300d4ff'>🚛</text><text y='80' font-size='20' fill='%23fff'>SC</text></svg>">
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;SC Haulmaster&quot;,&quot;short_name&quot;:&quot;Haulmaster&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230f1419&quot;,&quot;theme_color&quot;:&quot;%2300d4ff&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text y='50' font-size='40' fill='%2300d4ff'>🚛</text><text y='80' font-size='20' fill='%23fff'>SC</text></svg>&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 100%;
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            color: #e0e6ed;
            min-height: 100vh;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .container {
            background: rgba(26, 35, 50, 0.9);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #00d4ff;
            margin: 0 0 20px 0;
            font-size: 2em;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        
        .nav-tabs {
            display: flex;
            background: rgba(15, 20, 25, 0.6);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #e0e6ed;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
        }
        
        .nav-tab:not(.active):hover {
            background: rgba(0, 212, 255, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            background: rgba(15, 20, 25, 0.6);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 480px) {
            .input-group {
                flex-direction: row;
                align-items: center;
            }
        }
        
        label {
            font-weight: 600;
            color: #00d4ff;
            min-width: 120px;
            font-size: 0.9em;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            background: rgba(15, 20, 25, 0.8);
            color: #e0e6ed;
            font-size: 16px;
            flex: 1;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-height: 48px;
            touch-action: manipulation;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #dc3545, #b02a37);
        }
        
        button.small {
            padding: 8px 12px;
            font-size: 12px;
            min-height: 36px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            flex: none;
            cursor: pointer;
            accent-color: #00d4ff;
            background: rgba(15, 20, 25, 0.8);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 4px;
            appearance: none;
            -webkit-appearance: none;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .checkbox-group input[type="checkbox"]:checked {
            background: #00d4ff;
            border-color: #00d4ff;
        }
        
        .checkbox-group input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #0f1419;
            font-weight: bold;
            font-size: 12px;
        }
        
        .checkbox-group input[type="checkbox"]:hover {
            border-color: #00d4ff;
            box-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
        }
        
        .checkbox-group label {
            cursor: pointer;
            color: #e0e6ed;
            font-size: 0.9em;
            min-width: auto;
        }
        
        .results {
            background: rgba(15, 20, 25, 0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }
        
        .result-item {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
        }
        
        .result-header {
            font-size: 1.1em;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .box-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .box-size {
            background: rgba(0, 212, 255, 0.15);
            padding: 10px 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.3);
            font-size: 0.9em;
        }
        
        .efficiency {
            background: rgba(0, 212, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            white-space: nowrap;
        }
        
        .info-box {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .info-box h3 {
            color: #ffc107;
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        
        .box-sizes-reference {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }
        
        .box-size strong {
            display: block;
            font-size: 1.1em;
            color: #00d4ff;
        }
        
        .toggleable {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(0, 212, 255, 0.5);
            touch-action: manipulation;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toggleable:active {
            transform: scale(0.95);
        }
        
        .toggleable.disabled {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.5);
            opacity: 0.7;
        }
        
        #boxSizesContent {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        #boxSizesContent.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        .typeahead-container {
            position: relative;
            flex: 1;
            min-width: 350px;
        }
        
        @media (max-width: 768px) {
            .typeahead-container {
                min-width: 280px;
            }
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 20, 25, 0.95);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            transition: background-color 0.2s ease;
        }
        
        .dropdown-item:hover, .dropdown-item.highlighted {
            background: rgba(0, 212, 255, 0.2);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item-main {
            color: #e0e6ed;
            font-weight: 600;
        }
        
        .dropdown-item-detail {
            color: #999;
            font-size: 0.8em;
            margin-top: 2px;
        }
        
        /* Hierarchical dropdown styles */
        .dropdown-system {
            background: rgba(0, 212, 255, 0.15);
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .dropdown-system-header {
            padding: 12px 15px;
            color: #00d4ff;
            font-weight: 700;
            font-size: 1.1em;
            cursor: default;
            background: rgba(0, 212, 255, 0.1);
        }
        
        .dropdown-region {
            background: rgba(0, 212, 255, 0.08);
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }
        
        .dropdown-region-header {
            padding: 10px 15px 8px 25px;
            color: #a0aec0;
            font-weight: 600;
            font-size: 0.95em;
            cursor: default;
            background: rgba(0, 212, 255, 0.05);
        }
        
        .dropdown-location {
            padding: 8px 15px 8px 40px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 212, 255, 0.05);
            transition: background-color 0.2s ease;
        }
        
        .dropdown-location:hover, .dropdown-location.highlighted {
            background: rgba(0, 212, 255, 0.2);
        }
        
        .dropdown-location:last-child {
            border-bottom: none;
        }
        
        .dropdown-location-text {
            color: #e0e6ed;
            font-weight: 500;
        }
        
        .dropdown-no-results {
            padding: 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }
        
        .destination-group {
            margin-bottom: 30px;
        }
        
        .destination-header {
            background: rgba(0, 212, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #00d4ff;
        }
        
        .destination-header h4 {
            margin: 0 0 5px 0;
            color: #00d4ff;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .destination-stats {
            color: #e0e6ed;
            font-size: 0.9em;
        }
        
        .resource-list {
            margin-top: 20px;
        }
        
        .resource-item {
            background: rgba(0, 212, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .resource-info {
            flex: 1;
            min-width: 200px;
        }
        
        .resource-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        
        .resource-scu {
            color: #e0e6ed;
            margin-bottom: 5px;
        }
        
        .resource-route {
            color: #a0aec0;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .resource-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .summary-stats {
            background: rgba(0, 212, 255, 0.15);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #00d4ff;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #e0e6ed;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }
        
        .checkbox-group input[type="checkbox"]:hover {
            border-color: #00d4ff;
            box-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
        }
        

        
        .dropdown-resource {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 212, 255, 0.05);
            transition: background-color 0.2s ease;
        }
        
        .dropdown-resource:hover, .dropdown-resource.highlighted {
            background: rgba(0, 212, 255, 0.2);
        }
        
        .dropdown-resource:last-child {
            border-bottom: none;
        }
        
        .dropdown-resource-text {
            color: #e0e6ed;
            font-weight: 500;
        }
        
        .route-container {
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .route-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            margin: 8px 0;
            background: rgba(15, 20, 25, 0.6);
            border-radius: 6px;
            border-left: 4px solid #00d4ff;
        }
        
        .route-step-number {
            background: #00d4ff;
            color: #0f1419;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        
        .route-step-location {
            font-weight: 600;
            color: #e0e6ed;
            flex: 1;
        }
        
        .route-step-cargo {
            color: #a0aec0;
            font-size: 0.9em;
            text-align: right;
        }
        
        .route-step.new-planet {
            border-left: 4px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }
        
        .planet-indicator {
            color: #ff6b6b;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚛 SC Haulmaster</h1>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('resources')">Resource Manager</button>
            <button class="nav-tab" onclick="switchTab('optimizer')">SCU Optimizer</button>
            <button class="nav-tab" onclick="switchTab('config')">Configuration</button>
            <button class="nav-tab" onclick="switchTab('news')">News & Updates</button>
        </div>
        
        <!-- Resource Manager Tab -->
        <div id="resources" class="tab-content active">
            <div class="section">
                <div class="input-group">
                    <label for="sourceInput">Source:</label>
                    <div class="typeahead-container">
                        <input type="text" id="sourceInput" placeholder="Type source location (e.g., HDMS-Anderson, Lorville)..." autocomplete="off">
                        <div id="sourceDropdown" class="dropdown-menu"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="resourceSCU">SCU Amount:</label>
                    <input type="number" id="resourceSCU" placeholder="Enter SCU amount" min="1">
                </div>
                
                <div class="input-group">
                    <label for="resourceInput">Resource:</label>
                    <div class="typeahead-container">
                        <input type="text" id="resourceInput" placeholder="Type resource name (e.g., Agricium, Titanium)..." autocomplete="off">
                        <div id="resourceDropdown" class="dropdown-menu"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="destinationInput">Destination:</label>
                    <div class="typeahead-container">
                        <input type="text" id="destinationInput" placeholder="Type destination name (e.g., HDMS-Anderson, Lorville)..." autocomplete="off">
                        <div id="destinationDropdown" class="dropdown-menu"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <button onclick="addContractItem()">Add to Contract</button>
                    <button onclick="startNewContract()" style="margin-left: 10px;">New Contract</button>
                </div>
            </div>
            
            <div id="resourcesSummary" class="summary-stats" style="display: none;">
                <h3>Cargo Summary</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="totalResources">0</span>
                        <div class="stat-label">Contracts</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="totalSCU">0</span>
                        <div class="stat-label">Total SCU</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="totalBoxes">0</span>
                        <div class="stat-label">Total Boxes</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgEfficiency">0%</span>
                        <div class="stat-label">Avg Efficiency</div>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="secondary" onclick="clearAllContracts()">Clear All Contracts</button>
                </div>
            </div>
            
            <div class="resource-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>Contract List</h3>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button onclick="showHelp()" style="padding: 8px 12px; background: rgba(0, 212, 255, 0.2); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 4px; color: #00d4ff; cursor: pointer; font-size: 0.9em;">?</button>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #00d4ff; font-weight: 600; font-size: 0.9em;">View:</label>
                            <select id="viewMode" onchange="changeViewMode()" style="padding: 5px 10px; border-radius: 4px; background: rgba(15, 20, 25, 0.8); color: #e0e6ed; border: 1px solid rgba(0, 212, 255, 0.3);">
                                <option value="optimal">Optimal Route</option>
                                <option value="contract">By Contract</option>
                                <option value="orbit">By Orbit</option>
                                <option value="planet">By Planet</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="resourceListContent">
                    <div class="empty-state">
                        No resources added yet. Add some resources above to get started!
                    </div>
                </div>
            </div>
            

        </div>
        
        <!-- SCU Optimizer Tab -->
        <div id="optimizer" class="tab-content">
            <div class="section">
                <div class="input-group">
                    <label for="scuInput">Target SCU:</label>
                    <input type="number" id="scuInput" placeholder="Enter SCU value (e.g., 100)" min="1">
                    <button onclick="optimizeSingle()">Optimize</button>
                </div>
                
                <div class="input-group">
                    <label for="batchInput">Multiple SCU:</label>
                    <input type="text" id="batchInput" placeholder="Enter multiple values (e.g., 100, 150, 200)">
                    <button onclick="optimizeBatch()">Optimize All</button>
                </div>
            </div>
            
            <div id="optimizerResults" class="results" style="display: none;">
                <h2>Optimization Results</h2>
                <div id="optimizerResultContent"></div>
            </div>
        </div>
        
        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <div class="section">
                <h3>📦 Box Size Configuration</h3>
                <p>Configure which box sizes are available for optimization. These settings are saved automatically and apply to both the Resource Manager and SCU Optimizer.</p>
                
                <div class="info-box">
                    <h3>Available Box Sizes (SCU)</h3>
                    <p>Click on box sizes to enable/disable them. Green checkmarks (✓) are enabled, red crosses (✗) are disabled.</p>
                    <div class="box-sizes-reference">
                        <div class="box-ref toggleable" data-size="1" onclick="toggleBoxSize(1)">1 SCU ✓</div>
                        <div class="box-ref toggleable" data-size="2" onclick="toggleBoxSize(2)">2 SCU ✓</div>
                        <div class="box-ref toggleable" data-size="4" onclick="toggleBoxSize(4)">4 SCU ✓</div>
                        <div class="box-ref toggleable" data-size="8" onclick="toggleBoxSize(8)">8 SCU ✓</div>
                        <div class="box-ref toggleable disabled" data-size="16" onclick="toggleBoxSize(16)">16 SCU ✗</div>
                        <div class="box-ref toggleable disabled" data-size="24" onclick="toggleBoxSize(24)">24 SCU ✗</div>
                        <div class="box-ref toggleable disabled" data-size="32" onclick="toggleBoxSize(32)">32 SCU ✗</div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>💾 Settings</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="autoSave" checked>
                        <label for="autoSave">Auto-save configuration changes</label>
                    </div>
                    <div style="margin-top: 15px;">
                        <button onclick="resetToDefaults()" class="secondary">Reset to Defaults</button>
                        <button onclick="exportConfig()" style="margin-left: 10px;">Export Settings</button>
                        <button onclick="importConfig()" style="margin-left: 10px;">Import Settings</button>
                    </div>
                </div>
                
                <div class="info-box">
                    <h3>ℹ️ How It Works</h3>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Automatic Saving:</strong> Your box size preferences are saved automatically</li>
                        <li><strong>Cross-Tab Usage:</strong> Settings apply to both Resource Manager and SCU Optimizer</li>
                        <li><strong>Browser Storage:</strong> Settings persist between browser sessions</li>
                        <li><strong>Optimization Impact:</strong> Only enabled box sizes are used for calculations</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h3>📝 Manage Custom Destinations</h3>
                <div id="customDestinationsList"></div>
                <div style="margin-top:10px;color:#999;font-size:0.9em;">Custom destinations are only stored in your browser and are not shared or synced.</div>
            </div>
        </div>
        
        <!-- News & Updates Tab -->
        <div id="news" class="tab-content">
            <div class="section">
                <h3>🚀 Latest Updates</h3>
                
                <div class="info-box">
                    <h3>📅 Version 1.4 - Multiple Contracts & Smart Defaults</h3>
                    <p><strong>New Feature:</strong> Support for multiple contracts in a single session!</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>New Contract Button:</strong> Start a new contract without clearing existing deliveries</li>
                        <li><strong>Smart Defaults:</strong> Source and resource fields remember your last used values</li>
                        <li><strong>Multiple View Modes:</strong> View by optimal route, contract, orbit/system, or planet</li>
                        <li><strong>Enhanced Organization:</strong> Better grouping and display of complex multi-item contracts</li>
                    </ul>
                </div>
                
                <div class="info-box">
                    <h3>📅 Version 1.3 - Alias Support</h3>
                    <p><strong>New Feature:</strong> Location aliases for easier contract management!</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Alias System:</strong> Use "Rayari, Inc" as an alias for "Hickes Research" and "Deakins Research"</li>
                        <li><strong>Smart Resolution:</strong> Typeahead automatically resolves aliases to actual locations</li>
                        <li><strong>Clear Labeling:</strong> Alias results are clearly marked in the dropdown</li>
                        <li><strong>Flexible Mapping:</strong> One alias can map to multiple locations</li>
                    </ul>
                </div>
                
                <div class="info-box">
                    <h3>📅 Version 1.2 - Planet-Based Route Optimization</h3>
                    <p><strong>Major Enhancement:</strong> Intelligent route optimization that groups deliveries by planet!</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Planet Grouping:</strong> All deliveries to a single planet are grouped together</li>
                        <li><strong>Transfer Priority:</strong> Locations that are both sources and destinations are prioritized</li>
                        <li><strong>Visual Indicators:</strong> Red borders show when you're changing planets</li>
                        <li><strong>Cargo Flow Tracking:</strong> See exactly what cargo you'll carry at each step</li>
                    </ul>
                </div>
                
                <div class="info-box">
                    <h3>📅 Version 1.1 - Contract System & Route Optimization</h3>
                    <p><strong>Major Feature:</strong> Complete contract management with route optimization!</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Contract-Based System:</strong> Organize deliveries by source and destination pairs</li>
                        <li><strong>Route Optimization:</strong> Minimize backtracking with intelligent route planning</li>
                        <li><strong>Transfer Points:</strong> Prioritize locations that are both sources and destinations</li>
                        <li><strong>Cargo Capacity:</strong> Track cargo at each step of your journey</li>
                        <li><strong>Enhanced Display:</strong> Multiple view modes for different organizational needs</li>
                    </ul>
                </div>
                
                <div class="info-box">
                    <h3>📅 Version 1.0 - Initial Release</h3>
                    <p><strong>Foundation:</strong> Core SCU optimization and destination management!</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>SCU Optimizer:</strong> Find the most efficient box combinations for any SCU amount</li>
                        <li><strong>Destination Database:</strong> 100+ locations from Stanton and Pyro systems</li>
                        <li><strong>Hierarchical Search:</strong> Browse locations by system and region</li>
                        <li><strong>Custom Destinations:</strong> Add your own locations for flexibility</li>
                        <li><strong>Box Size Configuration:</strong> Enable/disable box sizes to match your ship's capabilities</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem 0; margin-top: 2rem; border-top: 1px solid rgba(0, 212, 255, 0.1); color: #718096;">
        <p>&copy; 2024 VayynePlays. Built with ❤️ and lots of ☕</p>
        <p style="margin-top: 0.5rem;">
            <a href="https://vayyneplays.github.io" style="color: #00d4ff; text-decoration: none; font-weight: 500;">← Back to Portfolio</a>
        </p>
    </footer>

    <script>
        // Available box sizes - can be toggled on/off
        let ENABLED_BOX_SIZES = [8, 4, 2, 1];
        const ALL_BOX_SIZES = [32, 24, 16, 8, 4, 2, 1];
        
        // Configuration storage keys
        const STORAGE_KEYS = {
            ENABLED_BOX_SIZES: 'sc_haulmaster_enabled_box_sizes',
            AUTO_SAVE: 'sc_haulmaster_auto_save'
        };
        
        // Contract list
        let contractList = [];
        let currentContractId = null;
        let lastUsedSource = '';
        let lastUsedResource = '';
        let currentViewMode = 'optimal';
        
        // Custom Destinations logic
        const CUSTOM_DESTINATIONS_KEY = 'sc_haulmaster_custom_destinations';
        let CUSTOM_DESTINATIONS = [];

        // Load destinations from JSON file
        fetch('destinations.json')
            .then(response => response.json())
            .then(data => {
                DESTINATIONS_HIERARCHICAL = data.hierarchical;
                DESTINATIONS_ALIASES = data.aliases || {};
                // Flatten destinations for search functionality
                DESTINATIONS_BASIC = [];
                Object.entries(DESTINATIONS_HIERARCHICAL).forEach(([system, regions]) => {
                    Object.entries(regions).forEach(([region, locations]) => {
                        locations.forEach(location => {
                            DESTINATIONS_BASIC.push(location);
                        });
                    });
                });
                DESTINATIONS_BASIC.sort();
                // If you need to trigger any UI updates or initialization that depend on destinations, do it here
            })
            .catch(error => {
                console.error('Failed to load destinations from JSON:', error);
                // Fallback: leave DESTINATIONS_HIERARCHICAL and DESTINATIONS_BASIC empty
                DESTINATIONS_ALIASES = {};
            });
        
        // Star Citizen resources - loaded from resources.json
        let RESOURCES = [];
        
        // Global variables for destinations
        let DESTINATIONS_HIERARCHICAL = {};
        let DESTINATIONS_BASIC = [];
        let DESTINATIONS_ALIASES = {};
        
        // Load resources from JSON file
        fetch('resources.json')
            .then(response => response.json())
            .then(data => {
                RESOURCES = data.commodities.sort();
                setupResourceTypeahead();
            })
            .catch(error => {
                console.error('Failed to load resources from JSON:', error);
                // Fallback to a basic list if JSON loading fails
                RESOURCES = ['Agricium', 'Aluminum', 'Beryl', 'Copper', 'Gold', 'Iron', 'Titanium', 'Tungsten'];
                setupResourceTypeahead();
            });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadConfiguration();
            setupTypeahead();
            setupSourceTypeahead();
            setupAutoSave();
            updateBoxSizeDisplay();
            loadCustomDestinations();
            updateCustomDestinationsUI();
        });
        
        function loadConfiguration() {
            // Load enabled box sizes from localStorage
            const savedBoxSizes = localStorage.getItem(STORAGE_KEYS.ENABLED_BOX_SIZES);
            if (savedBoxSizes) {
                try {
                    ENABLED_BOX_SIZES = JSON.parse(savedBoxSizes);
                } catch (e) {
                    console.warn('Failed to load box sizes from localStorage, using defaults');
                    ENABLED_BOX_SIZES = [8, 4, 2, 1];
                }
            }
            
            // Load auto-save setting
            const savedAutoSave = localStorage.getItem(STORAGE_KEYS.AUTO_SAVE);
            if (savedAutoSave !== null) {
                document.getElementById('autoSave').checked = savedAutoSave === 'true';
            }
        }
        
        function saveConfiguration() {
            if (document.getElementById('autoSave').checked) {
                localStorage.setItem(STORAGE_KEYS.ENABLED_BOX_SIZES, JSON.stringify(ENABLED_BOX_SIZES));
                localStorage.setItem(STORAGE_KEYS.AUTO_SAVE, document.getElementById('autoSave').checked.toString());
            }
        }
        
        function updateBoxSizeDisplay() {
            ALL_BOX_SIZES.forEach(size => {
                const boxElement = document.querySelector(`[data-size="${size}"]`);
                if (boxElement) {
                    const isEnabled = ENABLED_BOX_SIZES.includes(size);
                    if (isEnabled) {
                        boxElement.classList.remove('disabled');
                        boxElement.textContent = `${size} SCU ✓`;
                    } else {
                        boxElement.classList.add('disabled');
                        boxElement.textContent = `${size} SCU ✗`;
                    }
                }
            });
        }
        
        function resetToDefaults() {
            if (confirm('Reset all configuration to defaults?')) {
                ENABLED_BOX_SIZES = [8, 4, 2, 1];
                document.getElementById('autoSave').checked = true;
                updateBoxSizeDisplay();
                saveConfiguration();
                updateAllContractOptimizations();
            }
        }
        
        function exportConfig() {
            const config = {
                enabledBoxSizes: ENABLED_BOX_SIZES,
                autoSave: document.getElementById('autoSave').checked,
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sc_haulmaster_config.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const config = JSON.parse(e.target.result);
                            if (config.enabledBoxSizes && Array.isArray(config.enabledBoxSizes)) {
                                ENABLED_BOX_SIZES = config.enabledBoxSizes;
                                if (config.autoSave !== undefined) {
                                    document.getElementById('autoSave').checked = config.autoSave;
                                }
                                updateBoxSizeDisplay();
                                saveConfiguration();
                                updateAllResourceOptimizations();
                                alert('Configuration imported successfully!');
                            } else {
                                alert('Invalid configuration file format.');
                            }
                        } catch (e) {
                            alert('Failed to parse configuration file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function setupResourceTypeahead() {
            const input = document.getElementById('resourceInput');
            const dropdown = document.getElementById('resourceDropdown');
            let selectedIndex = -1;
            let selectableItems = [];
            
            // Show all resources when input is focused and empty
            input.addEventListener('focus', function() {
                if (this.value.length === 0) {
                    showAllResources();
                }
            });
            
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                
                if (query.length === 0) {
                    showAllResources();
                    return;
                }
                
                // Filter resources based on query
                const filteredResources = RESOURCES.filter(resource => 
                    resource.toLowerCase().includes(query)
                );
                showFilteredResources(filteredResources);
                selectedIndex = -1;
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, selectableItems.length - 1);
                    highlightResourceItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    highlightResourceItem();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && selectableItems[selectedIndex]) {
                        selectResource(selectableItems[selectedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    hideResourceDropdown();
                }
            });
            
            input.addEventListener('blur', function() {
                // Delay hiding to allow click events
                setTimeout(() => hideResourceDropdown(), 150);
            });
            
            function showAllResources() {
                dropdown.innerHTML = '';
                selectableItems = [];
                
                RESOURCES.forEach(resource => {
                    const resourceDiv = document.createElement('div');
                    resourceDiv.className = 'dropdown-resource';
                    resourceDiv.innerHTML = `<div class="dropdown-resource-text">${resource}</div>`;
                    resourceDiv.addEventListener('click', () => selectResource(resource));
                    dropdown.appendChild(resourceDiv);
                    selectableItems.push(resourceDiv);
                });
                
                dropdown.style.display = 'block';
            }
            
            function showFilteredResources(filteredResources) {
                dropdown.innerHTML = '';
                selectableItems = [];
                
                if (filteredResources.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'dropdown-no-results';
                    noResults.textContent = 'No resources found. Try a different search term.';
                    dropdown.appendChild(noResults);
                } else {
                    filteredResources.forEach(resource => {
                        const resourceDiv = document.createElement('div');
                        resourceDiv.className = 'dropdown-resource';
                        resourceDiv.innerHTML = `<div class="dropdown-resource-text">${resource}</div>`;
                        resourceDiv.addEventListener('click', () => selectResource(resource));
                        dropdown.appendChild(resourceDiv);
                        selectableItems.push(resourceDiv);
                    });
                }
                
                dropdown.style.display = 'block';
            }
            
            function hideResourceDropdown() {
                dropdown.style.display = 'none';
                selectedIndex = -1;
            }
            
            function highlightResourceItem() {
                selectableItems.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === selectedIndex);
                });
            }
            
            function selectResource(resource) {
                input.value = resource;
                input.dataset.selected = resource;
                hideResourceDropdown();
            }
        }
        
        function toggleBoxSize(size) {
            const boxElement = document.querySelector(`[data-size="${size}"]`);
            const isEnabled = ENABLED_BOX_SIZES.includes(size);
            
            if (isEnabled) {
                ENABLED_BOX_SIZES = ENABLED_BOX_SIZES.filter(s => s !== size);
                boxElement.classList.add('disabled');
                boxElement.textContent = `${size} SCU ✗`;
            } else {
                ENABLED_BOX_SIZES.push(size);
                ENABLED_BOX_SIZES.sort((a, b) => b - a);
                boxElement.classList.remove('disabled');
                boxElement.textContent = `${size} SCU ✓`;
            }
            
            // Save configuration to localStorage
            saveConfiguration();
            
            // Recalculate all contracts when box sizes change
            updateAllContractOptimizations();
        }
        
        function optimizeStorage(targetSCU) {
            if (ENABLED_BOX_SIZES.length === 0) {
                return null;
            }
            
            const dp = new Array(targetSCU + 1).fill(null);
            dp[0] = { boxes: {}, total: 0, efficiency: 100 };
            
            for (let i = 1; i <= targetSCU; i++) {
                let bestSolution = null;
                let minBoxes = Infinity;
                
                for (const boxSize of ENABLED_BOX_SIZES) {
                    if (i >= boxSize && dp[i - boxSize] !== null) {
                        const prevSolution = dp[i - boxSize];
                        const newBoxCount = prevSolution.total + 1;
                        
                        if (newBoxCount < minBoxes) {
                            minBoxes = newBoxCount;
                            const newBoxes = { ...prevSolution.boxes };
                            newBoxes[boxSize] = (newBoxes[boxSize] || 0) + 1;
                            
                            const maxBoxSize = Math.max(...ENABLED_BOX_SIZES);
                            bestSolution = {
                                boxes: newBoxes,
                                total: newBoxCount,
                                efficiency: (i / newBoxCount) * (100 / maxBoxSize)
                            };
                        }
                    }
                }
                
                dp[i] = bestSolution;
            }
            
            return dp[targetSCU];
        }
        
        function displayOptimizationResult(targetSCU, solution) {
            if (!solution) {
                return `<div class="result-item">
                    <div class="result-header">
                        ${targetSCU} SCU
                        <span class="efficiency">Impossible</span>
                    </div>
                    <p>No valid combination found for ${targetSCU} SCU with current enabled box sizes</p>
                </div>`;
            }
            
            const boxBreakdown = Object.entries(solution.boxes)
                .sort(([a], [b]) => parseInt(b) - parseInt(a))
                .map(([size, count]) => 
                    `<div class="box-size">
                        <strong>${count}x</strong>
                        ${size} SCU
                    </div>`
                ).join('');
            
            return `<div class="result-item">
                <div class="result-header">
                    ${targetSCU} SCU Storage
                    <span class="efficiency">${solution.efficiency.toFixed(1)}% efficient</span>
                </div>
                <p><strong>Total Boxes:</strong> ${solution.total}</p>
                <div class="box-breakdown">
                    ${boxBreakdown}
                </div>
            </div>`;
        }
        
        function optimizeSingle() {
            const input = document.getElementById('scuInput');
            const targetSCU = parseInt(input.value);
            
            if (!targetSCU || targetSCU < 1) {
                alert('Please enter a valid SCU value (1 or greater)');
                return;
            }
            
            if (ENABLED_BOX_SIZES.length === 0) {
                alert('Please enable at least one box size');
                return;
            }
            
            const solution = optimizeStorage(targetSCU);
            const resultsDiv = document.getElementById('optimizerResults');
            const contentDiv = document.getElementById('optimizerResultContent');
            
            contentDiv.innerHTML = displayOptimizationResult(targetSCU, solution);
            resultsDiv.style.display = 'block';
        }
        
        function optimizeBatch() {
            const input = document.getElementById('batchInput');
            const values = input.value.split(',').map(v => parseInt(v.trim())).filter(v => v > 0);
            
            if (values.length === 0) {
                alert('Please enter valid SCU values separated by commas');
                return;
            }
            
            if (ENABLED_BOX_SIZES.length === 0) {
                alert('Please enable at least one box size');
                return;
            }
            
            const resultsDiv = document.getElementById('optimizerResults');
            const contentDiv = document.getElementById('optimizerResultContent');
            
            let html = '';
            values.forEach(targetSCU => {
                const solution = optimizeStorage(targetSCU);
                html += displayOptimizationResult(targetSCU, solution);
            });
            
            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function startNewContract() {
            currentContractId = Date.now();
            // Clear destination and SCU, but keep source and resource as defaults
            document.getElementById('destinationInput').value = '';
            document.getElementById('destinationInput').dataset.selected = '';
            document.getElementById('destinationInput').dataset.planetMoon = '';
            document.getElementById('resourceSCU').value = '';
            
            // Set defaults for source and resource if we have them
            if (lastUsedSource) {
                // lastUsedSource now contains the complete name with planet/moon
                const sourceInput = document.getElementById('sourceInput');
                sourceInput.value = lastUsedSource;
                // Extract just the location name for the dataset
                const sourceName = lastUsedSource.split(' (')[0];
                sourceInput.dataset.selected = sourceName;
                // Extract planet/moon for the dataset
                const planetMatch = lastUsedSource.match(/\(([^)]+)\)$/);
                sourceInput.dataset.planetMoon = planetMatch ? planetMatch[1] : '';
            }
            if (lastUsedResource) {
                document.getElementById('resourceInput').value = lastUsedResource;
                document.getElementById('resourceInput').dataset.selected = lastUsedResource;
            }
            
            // Update display to show the new contract
            updateContractDisplay();
        }
        
        function addContractItem() {
            const sourceInput = document.getElementById('sourceInput');
            const destinationInput = document.getElementById('destinationInput');
            const resourceInput = document.getElementById('resourceInput');
            const scuInput = document.getElementById('resourceSCU');
            
            const source = sourceInput.value;
            const destination = destinationInput.value;
            const resource = resourceInput.value;
            const scu = parseInt(scuInput.value);
            
            if (!source) {
                alert('Please select a source');
                return;
            }
            
            if (!destination) {
                alert('Please select a destination');
                return;
            }
            
            if (!resource) {
                alert('Please select a resource');
                return;
            }
            
            if (!scu || scu < 1) {
                alert('Please enter a valid SCU amount');
                return;
            }
            
            // If no current contract, start a new one
            if (!currentContractId) {
                currentContractId = Date.now();
            }
            
            // Get the planet/moon names for source and destination
            let sourcePlanetMoon = sourceInput.dataset.planetMoon || '';
            let destPlanetMoon = destinationInput.dataset.planetMoon || '';
            
            if (!sourcePlanetMoon && typeof DESTINATIONS_HIERARCHICAL !== 'undefined') {
                outer: for (const [system, regions] of Object.entries(DESTINATIONS_HIERARCHICAL)) {
                    for (const [region, locations] of Object.entries(regions)) {
                        if (locations.includes && locations.includes(source)) {
                            sourcePlanetMoon = region;
                            break outer;
                        }
                    }
                }
            }
            
            if (!destPlanetMoon && typeof DESTINATIONS_HIERARCHICAL !== 'undefined') {
                outer: for (const [system, regions] of Object.entries(DESTINATIONS_HIERARCHICAL)) {
                    for (const [region, locations] of Object.entries(regions)) {
                        if (locations.includes && locations.includes(destination)) {
                            destPlanetMoon = region;
                            break outer;
                        }
                    }
                }
            }
            
            // Create full location strings with planet/moon
            const fullSource = sourcePlanetMoon ? `${source} (${sourcePlanetMoon})` : source;
            const fullDestination = destPlanetMoon ? `${destination} (${destPlanetMoon})` : destination;
            


            // Check if locations are not in any known list, and add as custom if needed
            let sourceKnown = false;
            let destKnown = false;
            
            if (typeof DESTINATIONS_BASIC !== 'undefined') {
                sourceKnown = DESTINATIONS_BASIC.includes(source);
                destKnown = DESTINATIONS_BASIC.includes(destination);
            } else if (typeof DESTINATIONS_HIERARCHICAL !== 'undefined') {
                outer: for (const sys of Object.values(DESTINATIONS_HIERARCHICAL)) {
                    for (const reg of Object.values(sys)) {
                        if (reg.includes) {
                            if (reg.includes(source)) sourceKnown = true;
                            if (reg.includes(destination)) destKnown = true;
                            if (sourceKnown && destKnown) break outer;
                        }
                    }
                }
            }
            
            if (!sourceKnown && typeof CUSTOM_DESTINATIONS !== 'undefined' && !CUSTOM_DESTINATIONS.includes(source)) {
                addCustomDestination(source);
            }
            if (!destKnown && typeof CUSTOM_DESTINATIONS !== 'undefined' && !CUSTOM_DESTINATIONS.includes(destination)) {
                addCustomDestination(destination);
            }

            const optimization = optimizeStorage(scu);
            
            const contractItem = {
                contractId: currentContractId,
                source: source,
                fullSource: fullSource,
                sourcePlanetMoon: sourcePlanetMoon,
                destination: destination,
                fullDestination: fullDestination,
                destPlanetMoon: destPlanetMoon,
                resource: resource,
                scu: scu,
                optimization: optimization,
                id: Date.now()
            };
            
            contractList.push(contractItem);
            
            // Store last used values for defaults
            lastUsedSource = fullSource; // Store the complete source name with planet/moon
            lastUsedResource = resource;
            
            // Clear only destination and SCU, keep source and resource for next item
            destinationInput.value = '';
            destinationInput.dataset.selected = '';
            destinationInput.dataset.planetMoon = '';
            scuInput.value = '';
            
            updateContractDisplay();
            updateContractSummary();
        }
        
        function removeContract(id) {
            contractList = contractList.filter(c => c.id !== id);
            updateContractDisplay();
            updateContractSummary();
        }
        
        function clearAllContracts() {
            if (contractList.length === 0) return;
            
            if (confirm('Are you sure you want to clear all contracts?')) {
                contractList = [];
                updateContractDisplay();
                updateContractSummary();
            }
        }
        
        function updateAllContractOptimizations() {
            contractList.forEach(contract => {
                contract.optimization = optimizeStorage(contract.scu);
            });
            updateContractDisplay();
            updateContractSummary();
        }
        
        function optimizeRoute() {
            if (contractList.length === 0) return [];
            
            // Extract planet/moon from location names
            function getPlanet(location) {
                const match = location.match(/\(([^)]+)\)$/);
                return match ? match[1] : 'Unknown';
            }
            
            // Group all locations by planet
            const planetGroups = {};
            contractList.forEach(contract => {
                const sourcePlanet = getPlanet(contract.fullSource);
                const destPlanet = getPlanet(contract.fullDestination);
                
                if (!planetGroups[sourcePlanet]) planetGroups[sourcePlanet] = [];
                if (!planetGroups[destPlanet]) planetGroups[destPlanet] = [];
                
                if (!planetGroups[sourcePlanet].includes(contract.fullSource)) {
                    planetGroups[sourcePlanet].push(contract.fullSource);
                }
                if (!planetGroups[destPlanet].includes(contract.fullDestination)) {
                    planetGroups[destPlanet].push(contract.fullDestination);
                }
            });
            
            // Find planets that are both sources and destinations (transfer planets)
            const transferPlanets = [];
            Object.keys(planetGroups).forEach(planet => {
                const isSource = contractList.some(c => getPlanet(c.fullSource) === planet);
                const isDestination = contractList.some(c => getPlanet(c.fullDestination) === planet);
                if (isSource && isDestination) {
                    transferPlanets.push(planet);
                }
            });
            
            // Create optimized route by planet
            const route = [];
            const visitedPlanets = new Set();
            const visitedLocations = new Set();
            
            // Start with transfer planets first (they're most valuable to visit early)
            transferPlanets.forEach(planet => {
                if (!visitedPlanets.has(planet)) {
                    // Add all locations on this planet
                    planetGroups[planet].forEach(location => {
                        if (!visitedLocations.has(location)) {
                            route.push(location);
                            visitedLocations.add(location);
                        }
                    });
                    visitedPlanets.add(planet);
                }
            });
            
            // Add remaining planets
            Object.keys(planetGroups).forEach(planet => {
                if (!visitedPlanets.has(planet)) {
                    // Add all locations on this planet
                    planetGroups[planet].forEach(location => {
                        if (!visitedLocations.has(location)) {
                            route.push(location);
                            visitedLocations.add(location);
                        }
                    });
                    visitedPlanets.add(planet);
                }
            });
            
            return route;
        }
        
        function calculateCargoAtLocation(location, routeIndex) {
            const cargo = {};
            
            // Extract planet from location
            function getPlanet(loc) {
                const match = loc.match(/\(([^)]+)\)$/);
                return match ? match[1] : 'Unknown';
            }
            
            // Calculate what cargo should be at this location based on the route
            contractList.forEach(contract => {
                const sourceIndex = routeIndex.findIndex(route => route === contract.fullSource);
                const destIndex = routeIndex.findIndex(route => route === contract.fullDestination);
                
                if (sourceIndex !== -1 && destIndex !== -1) {
                    const currentIndex = routeIndex.indexOf(location);
                    const currentPlanet = getPlanet(location);
                    const sourcePlanet = getPlanet(contract.fullSource);
                    const destPlanet = getPlanet(contract.fullDestination);
                    
                    // If we're at the source, we should pick up this cargo
                    if (currentIndex === sourceIndex) {
                        cargo[contract.resource] = (cargo[contract.resource] || 0) + contract.scu;
                    }
                    // If we're at the destination, we should deliver this cargo
                    else if (currentIndex === destIndex) {
                        cargo[contract.resource] = (cargo[contract.resource] || 0) - contract.scu;
                    }
                    // If we're on the same planet as source but not at source, and we've passed the source
                    else if (currentPlanet === sourcePlanet && currentIndex > sourceIndex) {
                        cargo[contract.resource] = (cargo[contract.resource] || 0) + contract.scu;
                    }
                    // If we're on the same planet as destination but not at destination, and we haven't reached destination yet
                    else if (currentPlanet === destPlanet && currentIndex < destIndex) {
                        cargo[contract.resource] = (cargo[contract.resource] || 0) + contract.scu;
                    }
                    // If we're between planets (source planet < current planet < destination planet)
                    else if (currentIndex > sourceIndex && currentIndex < destIndex) {
                        cargo[contract.resource] = (cargo[contract.resource] || 0) + contract.scu;
                    }
                }
            });
            
            return cargo;
        }
        
        function getSystemFromLocation(location) {
            // Find which system this location belongs to
            for (const [system, regions] of Object.entries(DESTINATIONS_HIERARCHICAL)) {
                for (const [region, locations] of Object.entries(regions)) {
                    if (locations.includes(location.split(' (')[0])) {
                        return system;
                    }
                }
            }
            return 'Unknown';
        }
        
        function getPlanetFromLocation(location) {
            const match = location.match(/\(([^)]+)\)$/);
            return match ? match[1] : 'Unknown';
        }
        
        function changeViewMode() {
            currentViewMode = document.getElementById('viewMode').value;
            updateContractDisplay();
        }
        
        function updateContractDisplay() {
            const container = document.getElementById('resourceListContent');
            
            if (contractList.length === 0) {
                container.innerHTML = '<div class="empty-state">No contracts added yet. Add some contracts above to get started!</div>';
                return;
            }
            
            let html = '';
            
            // Show optimized route only in optimal view
            if (currentViewMode === 'optimal') {
                const optimizedRoute = optimizeRoute();
                html += '<div class="section">';
                html += '<h3>🚛 Optimized Route (Planet-Based)</h3>';
                
                if (optimizedRoute.length > 0) {
                    html += '<div class="route-container">';
                    
                    // Extract planet from location
                    function getPlanet(loc) {
                        const match = loc.match(/\(([^)]+)\)$/);
                        return match ? match[1] : 'Unknown';
                    }
                    
                    let currentPlanet = null;
                    optimizedRoute.forEach((location, index) => {
                        const planet = getPlanet(location);
                        const isNewPlanet = planet !== currentPlanet;
                        currentPlanet = planet;
                        
                        const cargo = calculateCargoAtLocation(location, optimizedRoute);
                        const cargoHtml = Object.entries(cargo).map(([resource, amount]) => {
                            const sign = amount > 0 ? '+' : '';
                            const color = amount > 0 ? '#00d4ff' : '#ff6b6b';
                            return `<span style="color: ${color}; font-weight: 600;">${sign}${amount} SCU ${resource}</span>`;
                        }).join(', ');
                        
                        html += `
                            <div class="route-step ${isNewPlanet ? 'new-planet' : ''}">
                                <div class="route-step-number">${index + 1}</div>
                                <div class="route-step-location">
                                    ${location}
                                    ${isNewPlanet ? `<div class="planet-indicator">🌍 ${planet}</div>` : ''}
                                </div>
                                <div class="route-step-cargo">${cargoHtml || 'No cargo change'}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            // Group contracts based on view mode
            let groupedContracts = {};
            
            if (currentViewMode === 'contract') {
                // Group by contract ID
                groupedContracts = contractList.reduce((groups, contract) => {
                    const contractId = contract.contractId;
                    if (!groups[contractId]) {
                        groups[contractId] = [];
                    }
                    groups[contractId].push(contract);
                    return groups;
                }, {});
            } else if (currentViewMode === 'orbit') {
                // Group by orbit (system)
                groupedContracts = contractList.reduce((groups, contract) => {
                    const sourceSystem = getSystemFromLocation(contract.fullSource);
                    const destSystem = getSystemFromLocation(contract.fullDestination);
                    const key = `${sourceSystem} → ${destSystem}`;
                    if (!groups[key]) {
                        groups[key] = [];
                    }
                    groups[key].push(contract);
                    return groups;
                }, {});
            } else if (currentViewMode === 'planet') {
                // Group by planet
                groupedContracts = contractList.reduce((groups, contract) => {
                    const sourcePlanet = getPlanetFromLocation(contract.fullSource);
                    const destPlanet = getPlanetFromLocation(contract.fullDestination);
                    const key = `${sourcePlanet} → ${destPlanet}`;
                    if (!groups[key]) {
                        groups[key] = [];
                    }
                    groups[key].push(contract);
                    return groups;
                }, {});
            } else {
                // Default: group by source and destination
                groupedContracts = contractList.reduce((groups, contract) => {
                    const key = `${contract.fullSource} → ${contract.fullDestination}`;
                    if (!groups[key]) {
                        groups[key] = [];
                    }
                    groups[key].push(contract);
                    return groups;
                }, {});
            }
            
            // Sort contracts
            const sortedContracts = Object.keys(groupedContracts).sort();
            
            sortedContracts.forEach(groupKey => {
                const contracts = groupedContracts[groupKey];
                
                // Calculate group totals
                const groupTotalSCU = contracts.reduce((sum, c) => sum + c.scu, 0);
                const groupTotalBoxes = contracts.reduce((sum, c) => sum + (c.optimization ? c.optimization.total : 0), 0);
                const validOptimizations = contracts.filter(c => c.optimization);
                const groupAvgEfficiency = validOptimizations.length > 0 
                    ? validOptimizations.reduce((sum, c) => sum + c.optimization.efficiency, 0) / validOptimizations.length
                    : 0;
                
                html += `
                    <div class="destination-group">
                        <div class="destination-header">
                            <h4>${groupKey}</h4>
                            <div class="destination-stats">
                                ${groupTotalSCU} SCU • ${groupTotalBoxes} boxes • ${groupAvgEfficiency.toFixed(1)}% avg efficiency
                            </div>
                        </div>
                `;
                
                contracts.forEach(contract => {
                    const optimization = contract.optimization;
                    let optimizationHtml = '';
                    
                    if (optimization) {
                        const boxBreakdown = Object.entries(optimization.boxes)
                            .sort(([a], [b]) => parseInt(b) - parseInt(a))
                            .map(([size, count]) => 
                                `<div class="box-size">
                                    <strong>${count}x</strong>
                                    ${size} SCU
                                </div>`
                            ).join('');
                        
                        optimizationHtml = `
                            <div class="box-breakdown">
                                ${boxBreakdown}
                            </div>
                            <div style="margin-top: 10px;">
                                <span class="efficiency">${optimization.efficiency.toFixed(1)}% efficient • ${optimization.total} boxes</span>
                            </div>
                        `;
                    } else {
                        optimizationHtml = '<div class="efficiency">No valid optimization found</div>';
                    }
                    
                    html += `
                        <div class="resource-item">
                            <div class="resource-info">
                                <div class="resource-name">${contract.resource}</div>
                                <div class="resource-scu">${contract.scu} SCU</div>
                                <div class="resource-route">${contract.fullSource} → ${contract.fullDestination}</div>
                                ${optimizationHtml}
                            </div>
                            <div class="resource-actions">
                                <button class="secondary small" onclick="removeContract(${contract.id})">Remove</button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function updateContractSummary() {
            const summaryDiv = document.getElementById('resourcesSummary');
            
            if (contractList.length === 0) {
                summaryDiv.style.display = 'none';
                return;
            }
            
            summaryDiv.style.display = 'block';
            
            const totalContracts = contractList.length;
            const totalSCU = contractList.reduce((sum, c) => sum + c.scu, 0);
            const totalBoxes = contractList.reduce((sum, c) => {
                return sum + (c.optimization ? c.optimization.total : 0);
            }, 0);
            
            const validOptimizations = contractList.filter(c => c.optimization);
            const avgEfficiency = validOptimizations.length > 0 
                ? validOptimizations.reduce((sum, c) => sum + c.optimization.efficiency, 0) / validOptimizations.length
                : 0;
            
            document.getElementById('totalResources').textContent = totalContracts;
            document.getElementById('totalSCU').textContent = totalSCU;
            document.getElementById('totalBoxes').textContent = totalBoxes;
            document.getElementById('avgEfficiency').textContent = avgEfficiency.toFixed(1) + '%';
        }
        
        // Allow Enter key to trigger optimization
        document.getElementById('scuInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') optimizeSingle();
        });
        
        document.getElementById('batchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') optimizeBatch();
        });
        
        document.getElementById('resourceSCU').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addContractItem();
        });
        
        function showHelp() {
            const helpContent = `
                <div style="max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #00d4ff; margin-bottom: 20px;">📦 How to Use SC Haulmaster</h2>
                    
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <h3 style="color: #00d4ff; margin-top: 0;">Perfect for organizing multiple delivery contracts with planet-based route optimization!</h3>
                        <p>When you have several contracts and want to minimize interplanetary travel:</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e0e6ed;">Step-by-Step Guide:</h3>
                        <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Add Your Contracts:</strong> For each contract, specify the source, destination, resource, and SCU amount</li>
                            <li><strong>Review the Route:</strong> The tool automatically groups all deliveries to each planet together</li>
                            <li><strong>Check Cargo Flow:</strong> See exactly what cargo you'll be carrying at each step</li>
                            <li><strong>Organize Your Grid:</strong> Use the box breakdown to prepare cargo for each contract</li>
                        </ol>
                    </div>
                    
                    <div style="background: rgba(255, 193, 7, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(255, 193, 7, 0.3);">
                        <h3 style="color: #ffc107; margin-top: 0;">⚠️ Important Cargo Loading Tip</h3>
                        <p><strong>Load each contract onto the elevator separately!</strong> This ensures proper distribution to the various stacks on the grid. Don't try to load all contracts at once - the game's cargo system works best when you load contracts individually.</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e0e6ed;">Pro Tips:</h3>
                        <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
                            <li><strong>Route Optimization:</strong> The tool groups all locations on the same planet together to minimize interplanetary travel costs</li>
                            <li><strong>Red Borders:</strong> Indicate planet changes in the route display</li>
                            <li><strong>Transfer Points:</strong> Locations that are both sources and destinations are prioritized in the route</li>
                            <li><strong>Multiple View Modes:</strong> Use different view options to organize your contracts as needed</li>
                            <li><strong>Smart Defaults:</strong> Source and resource fields remember your last used values for faster contract entry</li>
                        </ul>
                    </div>
                    
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <h3 style="color: #00d4ff; margin-top: 0;">✅ Updated Destination Database</h3>
                        <p><strong>Fresh from <a href="https://uexcorp.space/resources/home/type/outposts/" target="_blank" rel="noopener" style="color: #00d4ff; text-decoration: none;">UEXcorp</a>!</strong> This destination list is current as of Star Citizen 4.1.1 LIVE and includes:</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Cargo Elevator Locations Only:</strong> All destinations have cargo elevators for delivery</li>
                            <li><strong>Stanton System:</strong> Major landing zones, stations, Lagrange points, and outposts with cargo terminals</li>
                            <li><strong>Pyro System:</strong> Alpha 4.0 outposts across Bloom, Monox, Terminus, and other moons</li>
                            <li><strong>100+ Deliverable Locations:</strong> Every location supports cargo delivery via elevators</li>
                        </ul>
                        <p>Type any location name to search, or enter custom destinations manually!</p>
                    </div>
                </div>
            `;
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                box-sizing: border-box;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: rgba(26, 35, 50, 0.95);
                border-radius: 12px;
                padding: 30px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
                border: 1px solid rgba(0, 212, 255, 0.3);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
            `;
            
            modalContent.innerHTML = helpContent;
            
            // Add close button
            const closeButton = document.createElement('button');
            closeButton.textContent = '✕';
            closeButton.style.cssText = `
                position: absolute;
                top: 15px;
                right: 15px;
                background: rgba(220, 53, 69, 0.8);
                border: none;
                color: white;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1;
                padding: 0;
            `;
            closeButton.onclick = () => document.body.removeChild(modal);
            
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }
        
        function setupAutoSave() {
            const autoSaveCheckbox = document.getElementById('autoSave');
            
            // Listen for changes to auto-save setting
            autoSaveCheckbox.addEventListener('change', function() {
                saveConfiguration();
            });
        }
        
        function resolveAlias(query) {
            // Check if the query matches any alias
            const normalizedQuery = query.toLowerCase().trim();
            for (const [alias, realNames] of Object.entries(DESTINATIONS_ALIASES)) {
                if (alias.toLowerCase() === normalizedQuery) {
                    return Array.isArray(realNames) ? realNames : [realNames];
                }
            }
            return null;
        }
        
        function setupTypeahead() {
            const input = document.getElementById('destinationInput');
            const dropdown = document.getElementById('destinationDropdown');
            let selectedIndex = -1;
            let selectableItems = [];
            
            // Show full hierarchy when input is focused and empty
            input.addEventListener('focus', function() {
                if (this.value.length === 0) {
                    showFullHierarchy();
                }
            });
            
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                
                if (query.length === 0) {
                    showFullHierarchy();
                    return;
                }
                
                // Check for aliases first
                const resolvedAlias = resolveAlias(this.value);
                if (resolvedAlias) {
                    // If we found an alias, show the real location
                    showAliasResult(resolvedAlias, this.value);
                    return;
                }
                
                // Filter destinations based on query
                const filteredResults = filterDestinations(query);
                showFilteredResults(filteredResults);
                selectedIndex = -1;
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, selectableItems.length - 1);
                    highlightItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    highlightItem();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && selectableItems[selectedIndex]) {
                        selectDestination(selectableItems[selectedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    hideDropdown();
                }
            });
            
            input.addEventListener('blur', function() {
                // Delay hiding to allow click events
                setTimeout(() => hideDropdown(), 150);
            });
            
            function showFullHierarchy() {
                dropdown.innerHTML = '';
                selectableItems = [];
                
                Object.entries(DESTINATIONS_HIERARCHICAL).forEach(([system, regions]) => {
                    const systemDiv = document.createElement('div');
                    systemDiv.className = 'dropdown-system';
                    
                    const systemHeader = document.createElement('div');
                    systemHeader.className = 'dropdown-system-header';
                    systemHeader.textContent = system;
                    systemDiv.appendChild(systemHeader);
                    
                    Object.entries(regions).forEach(([region, locations]) => {
                        const regionDiv = document.createElement('div');
                        regionDiv.className = 'dropdown-region';
                        
                        const regionHeader = document.createElement('div');
                        regionHeader.className = 'dropdown-region-header';
                        regionHeader.textContent = region;
                        regionDiv.appendChild(regionHeader);
                        
                        locations.forEach(location => {
                            const locationDiv = document.createElement('div');
                            locationDiv.className = 'dropdown-location';
                            locationDiv.innerHTML = `<div class="dropdown-location-text">${location} <span style="color: #999; font-size: 0.9em;">(${region})</span></div>`;
                            locationDiv.addEventListener('click', () => selectDestination(location, region));
                            regionDiv.appendChild(locationDiv);
                            selectableItems.push(locationDiv);
                        });
                        
                        systemDiv.appendChild(regionDiv);
                    });
                    
                    dropdown.appendChild(systemDiv);
                });
                
                dropdown.style.display = 'block';
            }
            
            function showAliasResult(realNames, alias) {
                dropdown.innerHTML = '';
                selectableItems = [];
                
                // Group locations by system and region
                const groupedLocations = {};
                
                realNames.forEach(realName => {
                    // Find the real location in the hierarchical structure
                    outer: for (const [system, regions] of Object.entries(DESTINATIONS_HIERARCHICAL)) {
                        for (const [region, locations] of Object.entries(regions)) {
                            if (locations.includes(realName)) {
                                if (!groupedLocations[system]) {
                                    groupedLocations[system] = {};
                                }
                                if (!groupedLocations[system][region]) {
                                    groupedLocations[system][region] = [];
                                }
                                groupedLocations[system][region].push(realName);
                                break outer;
                            }
                        }
                    }
                });
                
                // Create the dropdown structure
                Object.entries(groupedLocations).forEach(([system, regions]) => {
                    const systemDiv = document.createElement('div');
                    systemDiv.className = 'dropdown-system';
                    
                    const systemHeader = document.createElement('div');
                    systemHeader.className = 'dropdown-system-header';
                    systemHeader.textContent = system;
                    systemDiv.appendChild(systemHeader);
                    
                    Object.entries(regions).forEach(([region, locations]) => {
                        const regionDiv = document.createElement('div');
                        regionDiv.className = 'dropdown-region';
                        
                        const regionHeader = document.createElement('div');
                        regionHeader.className = 'dropdown-region-header';
                        regionHeader.textContent = region;
                        regionDiv.appendChild(regionHeader);
                        
                        locations.forEach(location => {
                            const locationDiv = document.createElement('div');
                            locationDiv.className = 'dropdown-location';
                            locationDiv.innerHTML = `
                                <div class="dropdown-location-text">
                                    ${location} <span style="color: #999; font-size: 0.9em;">(${region})</span>
                                    <div style="color: #00d4ff; font-size: 0.8em; margin-top: 2px;">Alias for: ${alias}</div>
                                </div>
                            `;
                            locationDiv.addEventListener('click', () => selectDestination(location, region));
                            regionDiv.appendChild(locationDiv);
                            selectableItems.push(locationDiv);
                        });
                        
                        systemDiv.appendChild(regionDiv);
                    });
                    
                    dropdown.appendChild(systemDiv);
                });
                
                dropdown.style.display = 'block';
            }
            
            function filterDestinations(query) {
                const results = [];
                
                Object.entries(DESTINATIONS_HIERARCHICAL).forEach(([system, regions]) => {
                    const systemResults = { system, regions: {} };
                    let hasMatches = false;
                    
                    Object.entries(regions).forEach(([region, locations]) => {
                        const matchingLocations = locations.filter(location => 
                            location.toLowerCase().includes(query)
                        );
                        
                        if (matchingLocations.length > 0) {
                            systemResults.regions[region] = matchingLocations;
                            hasMatches = true;
                        }
                    });
                    
                    if (hasMatches) {
                        results.push(systemResults);
                    }
                });
                
                return results;
            }
            
            function showFilteredResults(filteredResults) {
                dropdown.innerHTML = '';
                selectableItems = [];
                
                if (filteredResults.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'dropdown-no-results';
                    noResults.textContent = 'No matches found. Try a different search term or enter custom destination.';
                    dropdown.appendChild(noResults);
                } else {
                    filteredResults.forEach(({ system, regions }) => {
                        const systemDiv = document.createElement('div');
                        systemDiv.className = 'dropdown-system';
                        
                        const systemHeader = document.createElement('div');
                        systemHeader.className = 'dropdown-system-header';
                        systemHeader.textContent = system;
                        systemDiv.appendChild(systemHeader);
                        
                        Object.entries(regions).forEach(([region, locations]) => {
                            const regionDiv = document.createElement('div');
                            regionDiv.className = 'dropdown-region';
                            
                            const regionHeader = document.createElement('div');
                            regionHeader.className = 'dropdown-region-header';
                            regionHeader.textContent = region;
                            regionDiv.appendChild(regionHeader);
                            
                            locations.forEach(location => {
                                const locationDiv = document.createElement('div');
                                locationDiv.className = 'dropdown-location';
                                locationDiv.innerHTML = `<div class="dropdown-location-text">${location} <span style="color: #999; font-size: 0.9em;">(${region})</span></div>`;
                                locationDiv.addEventListener('click', () => selectDestination(location, region));
                                regionDiv.appendChild(locationDiv);
                                selectableItems.push(locationDiv);
                            });
                            
                            systemDiv.appendChild(regionDiv);
                        });
                        
                        dropdown.appendChild(systemDiv);
                    });
                }
                
                dropdown.style.display = 'block';
            }
            
            function hideDropdown() {
                dropdown.style.display = 'none';
                selectedIndex = -1;
            }
            
            function highlightItem() {
                selectableItems.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === selectedIndex);
                });
            }
            
            function selectDestination(dest, planetMoon = '') {
                // Store the complete destination name with planet/moon
                const completeDestination = planetMoon ? `${dest} (${planetMoon})` : dest;
                input.value = completeDestination;
                input.dataset.selected = dest;
                input.dataset.planetMoon = planetMoon;
                hideDropdown();
            }
        }
        
        function setupSourceTypeahead() {
            const input = document.getElementById('sourceInput');
            const dropdown = document.getElementById('sourceDropdown');
            let selectedIndex = -1;
            let selectableItems = [];
            
            // Show full hierarchy when input is focused and empty
            input.addEventListener('focus', function() {
                if (this.value.length === 0) {
                    showFullHierarchy();
                }
            });
            
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                
                if (query.length === 0) {
                    showFullHierarchy();
                    return;
                }
                
                // Filter destinations based on query
                const filteredResults = filterDestinations(query);
                showFilteredResults(filteredResults);
                selectedIndex = -1;
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, selectableItems.length - 1);
                    highlightItem();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    highlightItem();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && selectableItems[selectedIndex]) {
                        selectSource(selectableItems[selectedIndex]);
                    }
                } else if (e.key === 'Escape') {
                    hideDropdown();
                }
            });
            
            input.addEventListener('blur', function() {
                // Delay hiding to allow click events
                setTimeout(() => hideDropdown(), 150);
            });
            
            function showFullHierarchy() {
                dropdown.innerHTML = '';
                selectableItems = [];
                
                Object.entries(DESTINATIONS_HIERARCHICAL).forEach(([system, regions]) => {
                    const systemDiv = document.createElement('div');
                    systemDiv.className = 'dropdown-system';
                    
                    const systemHeader = document.createElement('div');
                    systemHeader.className = 'dropdown-system-header';
                    systemHeader.textContent = system;
                    systemDiv.appendChild(systemHeader);
                    
                    Object.entries(regions).forEach(([region, locations]) => {
                        const regionDiv = document.createElement('div');
                        regionDiv.className = 'dropdown-region';
                        
                        const regionHeader = document.createElement('div');
                        regionHeader.className = 'dropdown-region-header';
                        regionHeader.textContent = region;
                        regionDiv.appendChild(regionHeader);
                        
                        locations.forEach(location => {
                            const locationDiv = document.createElement('div');
                            locationDiv.className = 'dropdown-location';
                            locationDiv.innerHTML = `<div class="dropdown-location-text">${location} <span style="color: #999; font-size: 0.9em;">(${region})</span></div>`;
                            locationDiv.addEventListener('click', () => selectSource(location, region));
                            regionDiv.appendChild(locationDiv);
                            selectableItems.push(locationDiv);
                        });
                        
                        systemDiv.appendChild(regionDiv);
                    });
                    
                    dropdown.appendChild(systemDiv);
                });
                
                dropdown.style.display = 'block';
            }
            
            function filterDestinations(query) {
                const results = [];
                
                Object.entries(DESTINATIONS_HIERARCHICAL).forEach(([system, regions]) => {
                    const systemResults = { system, regions: {} };
                    let hasMatches = false;
                    
                    Object.entries(regions).forEach(([region, locations]) => {
                        const matchingLocations = locations.filter(location => 
                            location.toLowerCase().includes(query)
                        );
                        
                        if (matchingLocations.length > 0) {
                            systemResults.regions[region] = matchingLocations;
                            hasMatches = true;
                        }
                    });
                    
                    if (hasMatches) {
                        results.push(systemResults);
                    }
                });
                
                return results;
            }
            
            function showFilteredResults(filteredResults) {
                dropdown.innerHTML = '';
                selectableItems = [];
                
                if (filteredResults.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'dropdown-no-results';
                    noResults.textContent = 'No matches found. Try a different search term or enter custom destination.';
                    dropdown.appendChild(noResults);
                } else {
                    filteredResults.forEach(({ system, regions }) => {
                        const systemDiv = document.createElement('div');
                        systemDiv.className = 'dropdown-system';
                        
                        const systemHeader = document.createElement('div');
                        systemHeader.className = 'dropdown-system-header';
                        systemHeader.textContent = system;
                        systemDiv.appendChild(systemHeader);
                        
                        Object.entries(regions).forEach(([region, locations]) => {
                            const regionDiv = document.createElement('div');
                            regionDiv.className = 'dropdown-region';
                            
                            const regionHeader = document.createElement('div');
                            regionHeader.className = 'dropdown-region-header';
                            regionHeader.textContent = region;
                            regionDiv.appendChild(regionHeader);
                            
                            locations.forEach(location => {
                                const locationDiv = document.createElement('div');
                                locationDiv.className = 'dropdown-location';
                                locationDiv.innerHTML = `<div class="dropdown-location-text">${location} <span style="color: #999; font-size: 0.9em;">(${region})</span></div>`;
                                locationDiv.addEventListener('click', () => selectSource(location, region));
                                regionDiv.appendChild(locationDiv);
                                selectableItems.push(locationDiv);
                            });
                            
                            systemDiv.appendChild(regionDiv);
                        });
                        
                        dropdown.appendChild(systemDiv);
                    });
                }
                
                dropdown.style.display = 'block';
            }
            
            function hideDropdown() {
                dropdown.style.display = 'none';
                selectedIndex = -1;
            }
            
            function highlightItem() {
                selectableItems.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === selectedIndex);
                });
            }
            
            function selectSource(source, planetMoon = '') {
                // Store the complete source name with planet/moon
                const completeSource = planetMoon ? `${source} (${planetMoon})` : source;
                input.value = completeSource;
                input.dataset.selected = source;
                input.dataset.planetMoon = planetMoon;
                hideDropdown();
            }
        }
        
        function loadCustomDestinations() {
            const saved = localStorage.getItem(CUSTOM_DESTINATIONS_KEY);
            if (saved) {
                try {
                    CUSTOM_DESTINATIONS = JSON.parse(saved);
                } catch (e) {
                    CUSTOM_DESTINATIONS = [];
                }
            } else {
                CUSTOM_DESTINATIONS = [];
            }
        }
        
        function saveCustomDestinations() {
            localStorage.setItem(CUSTOM_DESTINATIONS_KEY, JSON.stringify(CUSTOM_DESTINATIONS));
        }
        
        function addCustomDestination(name) {
            if (!CUSTOM_DESTINATIONS.includes(name)) {
                CUSTOM_DESTINATIONS.push(name);
                saveCustomDestinations();
                updateCustomDestinationsUI();
            }
        }
        
        function removeCustomDestination(name) {
            CUSTOM_DESTINATIONS = CUSTOM_DESTINATIONS.filter(dest => dest !== name);
            saveCustomDestinations();
            updateCustomDestinationsUI();
        }
        
        function updateCustomDestinationsUI() {
            // Management UI in config tab
            const container = document.getElementById('customDestinationsList');
            if (!container) return;
            if (CUSTOM_DESTINATIONS.length === 0) {
                container.innerHTML = '<div style="color:#999;">No custom destinations added.</div>';
                return;
            }
            container.innerHTML = CUSTOM_DESTINATIONS.map(dest =>
                `<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                    <span style="flex:1;">${dest}</span>
                    <button class="secondary small" onclick="removeCustomDestination('${dest.replace(/'/g, "\\'")}')">Remove</button>
                </div>`
            ).join('');
        }
    </script>
</body>
</html>
</html>